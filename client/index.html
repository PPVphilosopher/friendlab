<html>
	<link rel="stylesheet" href="jquery.mobile-1.3.1.css" />
	<script src="jquery-1.9.1.js"></script>
	<script src="html2canvas.js"></script>
	<script src="jquery.mobile-1.3.1.min.js"></script>
	<script src="all.js"></script>


	<!--.....html code........................................................................................-->


	<head>
		<title>
			Friend Lab
		</title>
	</head>
	<body>


	<!--.................CSS style code.......................................................................-->


	<style type="text/css">
		div.hungry {background-color:#66cc33; 
			height:2em; 
			width:90%; 
			color:#FFF; 
			text-align:center;
			padding:5px auto;
			-webkit-border-radius:10px;
			-moz-border-radius:10px;
			border-radius:10px;
			margin:0 5%;
			vertical-align:middle;
			line-height:35px;}
		div.energy {background-color:#66cc33;
			height:2em;width:90%;
			color:#FFF; 
			text-align:center;
			-webkit-border-radius:10px;
			-moz-border-radius:10px;
			border-radius:10px;
			margin:0 5%;
			vertical-align:middle;
			line-height:35px;}
		div.clean  {background-color:#66cc33;
			height:2em;
			width:90%; 
			color:#FFF; 
			text-align:center;
			-webkit-border-radius:10px;
			-moz-border-radius:10px;
			border-radius:10px;
			margin:0 5%;
			vertical-align:middle;
			line-height:35px;}
		div.bg1{background-image:url(bg/lab02.jpg);
			height:524px;
			width:320px;
			background-size:cover;}
		div.htp1.r1{background-image:url(images/rhtp1.png);width:300px;
			height:380px;
			background-size:cover;
			margin-top:-15px;
			margin-left:10px;
			background-repeat:no-repeat;}
		div.htp1.r2{background-image:url(images/rhtp2.png);width:300px;
			height:380px;
			background-size:cover;
			margin-top:-15px;
			margin-left:10px;
			background-repeat:no-repeat;}
		div.htp1.r3{background-image:url(images/rhtp3.png);width:300px;
			height:380px;
			background-size:cover;
			margin-top:-15px;
			margin-left:10px;
			background-repeat:no-repeat;}
		div.htp1.r4{background-image:url(images/rhtp4.png);width:300px;
			height:380px;
			background-size:cover;
			margin-top:-15px;
			margin-left:10px;
			background-repeat:no-repeat;}
		div.mfp1{background-image:url(images/mfp1.png);}
		div.mfp2{background-image:url(images/mfp2.png);}
		div.btime{background-image:url(images/minigameButton.png);
			height:58px;background-size:cover;}
		div.non{background-image:url(images/non.png);
			width:80px;
			height:80px;
			background-size:cover;}
		div.mon1{background-image:url(images/mon1.png);
			width:80px;
			height:80px;
			background-size:cover;}
		div.mon2{background-image:url(images/mon3.png);
			width:80px;
			height:80px;
			background-size:cover;}
		div.mon3{background-image:url(images/mon2.png);
			width:80px;
			height:80px;
			background-size:cover;}
		div.mon4{background-image:url(images/mon4.png);
			width:80px;
			height:80px;
			background-size:cover;}
		div.boom1{background-image:url(images/boom1.png);
			width:80px;
			height:80px;
			background-size:cover;}
		div.boom2{background-image:url(images/boom3.png);
			width:80px;
			height:80px;
			background-size:cover;}
		div.boom3{background-image:url(images/boom2.png);
			width:80px;
			height:80px;
			background-size:cover;}
		div.boom4{background-image:url(images/boom4.png);
			width:80px;
			height:80px;
			background-size:cover;}
		div.doc{background-image:url(images/doc.png);
			width:80px;
			height:80px;
			background-size:cover;}
		div.docomg{background-image:url(images/docomg.png);
			width:80px;
			height:80px;
			background-size:cover;}
		div.timer{background-image:url(images/timer.png);
			width:80px;
			height:80px;
			background-size:cover;}
		div.plus3{background-image:url(images/plus3.png);
			width:80px;
			height:80px;
			background-size:cover;}
	</style>


	<div id="fb-root">
		<script>

			$add = 'http://localhost/'
		//	$add = 'http://apps.socialhappen.com/'
			$top = [180,200,220,180]	

			$id = 0
			$pic = 0
			$avaid = 0
			var clock = 0

			var int_decrease = setInterval(function(){},0)
			var int_sleep = setInterval(function(){},0)
			var int_return = setInterval(function(){},0)
			
			var loadpic = []
			loadpic['ava0'] = image('images/images/b_01.png')
			loadpic['ava1'] = image('images/images/b_02.png')
			loadpic['ava2'] = image('images/images/b_03.png')
			loadpic['ava3'] = image('images/images/b_04.png')
			loadpic['lab'] = image('bg/lab01.jpg')
			loadpic['bed1'] = image('bg/bed01.jpg')
			loadpic['bed2'] = image('bg/bed02.png')
			loadpic['bth1'] = image('bg/bath01.jpg')
			loadpic['bth2'] = image('bg/bath02.png')
			loadpic['kit1'] = image('bg/kitchen01.jpg')
			loadpic['kit2'] = image('bg/kitchen02.png')

		//..........facebook code..............................................................................


			window.fbAsyncInit = function() {
				FB.init({
					appId :'405891112842517', // App ID
					channelUrl : $add+'friendlab', // Channel File
					status :true, // check login status
					cookie :true, // enable cookies to allow the server to access the session
					xfbml :true // parse XFBML
				});
				// Here we subscribe to the auth.authResponseChange JavaScript Event. This event is fired
				// for any auth related change, such as login, logout or session refresh. This means that
				// whenever someone who was previously logged out then logs in, the correct case below
				// will be handled.
				FB.Event.subscribe('auth.authResponseChange', function(response) {
					// Here we specify what we do with the response anytime this event occurs.
					if (response.status === 'connected') {
						// The response object is returned with a status field that lets us know what the current
						// login status of the person is. In this case, we're handling the situation where they
						// have logged in to the app.
						console.log('connected');
						testAPI();
					} else if (response.status === 'not_authorized') {
						// In this case, the person is logged into Facebook, but not into the app, so we call
						// FB.login() to prompt them to do so.
						// In real-life usage, you wouldn't want to immediately prompt someone to login
						// like this, for two reasons:
						// (1) JavaScript created popup windows are blocked by most browsers unless they
						// result from direct user interaction (such as a mouse click)
						// (2) it is a bad experience to be continually prompted to login upon page load.
						console.log('not_authorized');
						FB.login();
					} else {
						// In this case, the person is not logged into Facebook, so we call the login()
						// function to prompt them to do so. Note that at this stage there is no indication
						// of whether they are logged into the app. If they aren't then they'll see the Login
						// Dialog right after they login to Facebook.
						// The same caveats as above apply to the FB.login() call here.
						console.log('neither');
						FB.login();
					}
				});
			};
			// Load the SDK Asynchronously
			(function(d){
				var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
				if (d.getElementById(id)) {return;}
				js = d.createElement('script'); js.id = id; js.async = true;
				js.src = "all.js";
				ref.parentNode.insertBefore(js, ref);
			}(document));
			// Here we are just running a very simple test of the Graph API after login is successful.
			// This testAPI() function is only called in those cases.
			function testAPI() {
				FB.api('/me', function(response) {
					console.log(response.id+' :'+response.name)
					clear()
					$('#content').css({'background-image':'url(bg/lab1x.jpg)'})
					$id = response.id
					$('#stl').html('<a href"#" onclick="init()"><img src="https://graph.facebook.com/'+$id+'/picture?type=square" style="width:40;height:40"></a>')
					$('#stl').css({'margin':'337 190'})
					$('#btl').html('<img src="GRAPHIC/logoapp.png" style="width:360;height:240;margin:40 -20">'+
						'<a href"#" onclick="init()"><img src="GRAPHIC/facebookas.png" style="width:210;height:70;margin:0 55"></a>'+
						'<a href"#" onclick="diff()"><img src="GRAPHIC/facebookdiff.png" style="width:210;height:70;margin:20 55"></a>'						
					)
					$('body').trigger('create')
				});
			}

			function diff(){
				FB.logout()
				$('#stl').css({'margin':'0 0'})
				$('#stl').html('<img src="GRAPHIC/logoapp.png" style="width:360;height:240;margin:40 -20">'+
						'<a href"#" onclick="FB.login(function(){},{scope:\'publish_stream\'})"><img src="GRAPHIC/facebook.png" style="width:210;height:70;margin:0 55"></a>')
				$('#btl').html()
			}



			//..........game code.................................................................................




			function init(){
				$.get($add+'friendlab/'+$id+'/status').complete(function(e){
					var q = JSON.parse(e.responseText)
					clear()
					if(q.success){
						draw_main()
					}else{
						htp()
					}
				})
			}

			function htp(){
				console.log('how to play start')
				$('#mhead').html('How to play')
				$('#stl').html(
					'<table border=\'0\' width="100%">'+
						'<col width="10%">'+
						'<col width="30%">'+
						'<col width="30%">'+
						'<col width="30%">'+
						'<tr>'+
							'<td><img src="images/frlab_15.png" style="height:38;"></td>'+
							'<td bgcolor=\'#000\' style="-webkit-border-radius:15px;-moz-border-radius:15px; border-radius:15px;"><div class=\'hungry\'>Hungry</div></td>'+
							'<td bgcolor=\'#000\' style="-webkit-border-radius:15px;-moz-border-radius:15px; border-radius:15px;"><div class=\'energy\'>Energy</div></td>'+
							'<td bgcolor=\'#000\'style="-webkit-border-radius:15px;-moz-border-radius:15px; border-radius:15px;"> <div class=\'clean\'>Clean</div></td>'+
						'</tr>'+
					'</table>'+
					'<div>'+
						'<table width="100%">'+
							'<tr>'+
								'<td>'+
									'<div>'+
										'<img src="images/gold.png" style="height:30px;">100'+
									'</div>'+
								'</td> '+
								'<td align="right">'+
									'<div>'+
										'<img src="images/sharebutton.png" style="height:25px;">'+
									'</div>'+
								'</td>'+
							'</tr>'+
						'</table>'+
					'</div>'+
					'<div id="page1">'+
						'<div class="htp1 r1"></div>'+
					'</div>'+
					'<div align=center>'+
						'<a href="#" onclick="new_char()">'+
							'<img src="images/buttonplay.png" style="height:53px;margin-top:12px;">'+
						'</a>'+
					'</div>'
				)
				$('#stl').addClass('bg1')

				$(document).ready(function(){
					$swipe=1;
					$(function(){
						$('div.htp1').on('swipeleft',swipeHandler);
						function swipeHandler(event){
							if($swipe<4){
								$(event.target).removeClass('r1 r2 r3 r4');
								$(event.target).addClass( 'r'+($swipe+1) );
								$swipe=$swipe+1;
							}
						}
					});

					$(function(){
						$('div.htp1').on('swiperight',swipeHandler);
						function swipeHandler(event){
							if($swipe>1){
								$(event.target).removeClass('r1 r2 r3 r4');
								$(event.target).addClass( 'r'+($swipe-1) );
								$swipe=$swipe-1;
							}
						}
					});
				});
				console.log('how to play finish')
			}

			function new_char(){
				console.log('new char start')
				$('#mhead').html('New character')
				$('#stl').removeClass('r1 r2 r3 r4 bg1')
				$('#stl').html('')
				$('#content').css({'background-image':'url(bg/lab01.jpg)'})
				$('#ctl').html(
					'<div style="width:300px;height:500px;background-image:url(bg/newchar.png);background-size:cover;margin:10">'+
						'<img src=images/fr.png style="width:250;height:50;margin:15 25">'+
						'<div id="list" align=center style="width:250px;height:400px;background-image:url(bg/newcharbox.png);background-size:cover;overflow:auto;margin:-10 25">'+
							''+
						'</div>'+
					'</div>'
				)
				FB.api('/me/friends', function(res) {
					res.data.sort(function(a,b){
						return ((a['name']<b['name'])?-1:((a['name']>b['name'])?1:0))
					})
					var i = 0;
					for(pr in res.data){
						var xid = res.data[pr]["id"]
						var xname = res.data[pr]["name"]
						$('#list').append('<a href="#" onclick="sel('+xid+')"><img src="https://graph.facebook.com/'+xid+'/picture?width=100&height=100"><br>'+xname+'</a><br>-------------------------------------<br>')
						i++
						if(i>9)break
					}
				})
				console.log('new char finish')
			}

			function sel(xid){
				console.log('select '+xid+' start')
				FB.api('/'+xid,function(res){
					$('#stl').html(
						'<div style="background-image:url(bg/sel.png);background-size:cover;width:320px;height:524px;position:absolute" align=center>'+
							'<br><h1>Your selection is</h1><br>'+
							'<img src="https://graph.facebook.com/'+xid+'/picture?width=100&height=100"><br>'+
							'<h2>'+res.name+'</h2><br>'+
							'<table>'+
								'<tr>'+
									'<td>'+
										'<a href="#" onclick="dissel()"><img src="images/Buttonback.png" style="height:50"></a>'+
									'</td>'+
									'<td>'+
										'<a href="#" onclick="choose_mixer('+xid+')"><img src="images/Buttonnext.png" style="height:50"></a>'+
									'</td>'+
								'</tr>'+
							'</table>'+
						'</div>'
					)
				})
				console.log('select '+xid+' finish')
			}

			function dissel(){
				console.log('disselect start')
				$('#stl').html('')
				console.log('disselect finish')
			}

			function choose_mixer(xid){
				$avaid = xid
				console.log('choose mixer start')
				clear()
				$('#mhead').html('New character')
				$('#stl').html(
					'<img src=images/choose.png style="width:300;margin:10 10">'+
					'<img src=images/setA.png style="width:80;margin-left:10">'+
					'<div align="center">'+
						'<form>'+
							'<fieldset data-role="controlgroup" data-type="horizontal">'+
								'<input type="radio" data-theme="a" name="setA" id="mix1" value=1 checked="checked">'+
								'<label for="mix1"><img src="images/set1-mix1.png" style="height:120px;"></label>'+
								'<input type="radio" data-theme="a" name="setA" id="mix2" value=2>'+
								'<label for="mix2"><img src="images/set1-mix2.png" style="height:120px;"></label>'+
								'<input type="radio" data-theme="a" name="setA" id="mix3" value=3>'+
								'<label for="mix3"><img src="images/set1-mix3.png" style="height:120px;"></label>'+
							'</fieldset>'+
						'</form>'+
					'</div>'+
					'<img src=images/setB.png style="width:80;margin-left:10">'+
					'<div align="center">'+
						'<form>'+
							'<fieldset data-role="controlgroup" data-type="horizontal">'+
								'<input type="radio" data-theme="a" name="setB" id="mix1" value=1 checked="checked">'+
								'<label for="mix1"><img src="images/set2-mix1.png" style="height:60px;"></label>'+
								'<input type="radio" data-theme="a" name="setB" id="mix2" value=2>'+
								'<label for="mix2"><img src="images/set2-mix2.png" style="height:60px;"></label>'+
								'<input type="radio" data-theme="a" name="setB" id="mix3" value=3>'+
								'<label for="mix3"><img src="images/set2-mix3.png" style="height:60px;"></label>'+
							'</fieldset>'+
						'</form>'+
					'</div>'+
					'<div align="right">'+
						'<a href="#" onclick="new_char2()">'+
							'<img src="images/Buttonnext.png" style="height:53px;margin:12 10;">'+
						'</a>'+
					'</div>'
				)
				$('body').trigger('create')
				$('#stl').addClass('bg1')
				console.log('choose mixer finish')
			}

			function new_char2(){
				console.log('new char2 start')
				$pic = Math.floor(Math.random()*4)
				var a = $("input:radio[name='setA']:checked").val()
				var b = $("input:radio[name='setB']:checked").val()
				$('#stl').html(
					'<div id="mix0" style="width:320;height:524;overflow:hidden;position:absolute;z-index:3"></div>'+
					'<div id="mix1" style="width:320;height:524;overflow:hidden;position:absolute;z-index:2"></div>'+
					'<div id="mix2" style="width:320;height:524;overflow:hidden;position:absolute;z-index:1"></div>'
				)
				$('#mix0').html('<img src=images/boom.png id="mix" style="width:0;margin-top:220;margin-left:160">')
				$('#mix1').html('<img src=images/set2-mix'+b+'.png id="mixB" style="margin:150 320">')
				$('#mix2').html('<img src=images/set1-mix'+a+'.png id="mixA" style="margin:100 0">')
				setTimeout(function(){
					$('#mixA').animate({marginLeft:"+=80px"},300)
					$('#mixB').animate({marginLeft:"-=160px"},300)
					$('#mixA').animate({height:"-=250px",marginLeft:"+=80px",marginTop:"+=125px"},500)
					$('#mixB').animate({height:"-=150px",marginTop:"+=75px"},500)
					setTimeout(function(){
						$('#mix').animate({width:"+=320px",marginLeft:"-=160px",marginTop:"-=100px"},500)
						setTimeout(function(){
							$('#mix1').html('<img src=bg/white.png style="width:320;height:524" id="white">')
							$('#mix').fadeOut(2000)
							$('#white').fadeIn(2000,new_char3())
						},500)
					},300)
				},50)
				console.log('new char2 finish')
			}

			function new_char3(){
				console.log('new char3 start')
				$('#mix0').html('<img src=bg/white.png style="width:320;height:524" id="white">')
				$('#mix1').html('<img id="xxx" src=images/images/b_0'+($pic+1)+'.png style="width:300;margin:'+($top[$pic]-100)+' 10">')
				$('#mix2').html('<img id="yyy" src=https://graph.facebook.com/'+$avaid+'/picture?width=76&height=76 style="margin:'+($top[$pic]-10)+' 122">')
				$('#xxx').animate({marginTop:"+=100px"},2000)
				$('#yyy').animate({marginTop:"+=100px"},2000)
				var time = new Date().getTime()
				$.post($add+'friendlab/new/'+$id+'/'+$avaid+'/'+$pic+'/'+time)
				$('#white').fadeOut(3000,function(){
					$('#mix0').html('<a href="#" onclick="start()"><img src=images/Buttonplay.png style="width:160;margin:20 80"></a>')
				})
				console.log('new char3 finish')
			}

			function start(){
				clear()
				draw_main()
				rt()
			}

			function draw_main(){
				console.log("draw_main start")
				$('#content').html('<div id="stl" style=\'position:absolute;z-index:5\'>'+
						'<img src="GRAPHIC/logoapp.png" style="width:360;height:240;margin:40 -20">'+
						'<a href"#" onclick="FB.login(function(){},{scope:\'read_friendlists\'})"><img src="GRAPHIC/facebook.png" style="width:210;height:70;margin:0 55"></a>'+
					'</div>'+
					'<div id="btl" style=\'position:absolute;z-index:4\'></div>'+
					'<div id="fnl" style=\'position:absolute;z-index:3\'></div>'+
					'<div id="ctl" style=\'position:absolute;z-index:2\'></div>')
				$('#mhead').html('Friendlab')
				$('#rhead').html('<a href="#" onclick="minigame()"><img src="images/mini.png" style="width:36px"></a>')
				$('#lhead').html('<a href="#" onclick="kill_b()"><img src="images/reset.png" style="width:32px"></a>')
				$('#stl').css({'margin-top':'0','margin-left':'0'})
				$('#stl').html(
					'<table border="0" width="100%" style="width:20em;" >'+
						'<col width="10%">'+
						'<col width="30%">'+
						'<col width="30%">'+
						'<col width="30%">'+
						'<tr>'+
							'<td>'+
								'<div id="mood">'+
									'<img src="images/normal.png" style="height:38;">'+
								'</div>'+
							'</td>'+
							'<td bgcolor="#000" style="-webkit-border-radius:15px;-moz-border-radius:15px; border-radius:15px;">'+
								'<div id="hg"style="background-color:#66cc33;height:2em;width:90%;color:#FFF;text-align:center;-webkit-border-radius:10px;-moz-border-radius:10px;border-radius:10px;margin:0 5%;vertical-align:middle;line-height:35px;">'+
										'Hungry'+
								'</div>'+
							'</td>'+
							'<td bgcolor="#000" style="-webkit-border-radius:15px;-moz-border-radius:15px; border-radius:15px;">'+
								'<div id="en" style="background-color:#66cc33;height:2em;width:90%;color:#FFF;text-align:center;-webkit-border-radius:10px;-moz-border-radius:10px;border-radius:10px;margin:0 5%;vertical-align:middle;line-height:35px;">'+
										'Energy'+
								'</div>'+
							'</td>'+
							'<td bgcolor="#000"style="-webkit-border-radius:15px;-moz-border-radius:15px; border-radius:15px;">'+
								'<div id="cl" style="background-color:#66cc33;height:2em;width:90%;color:#FFF;text-align:center;-webkit-border-radius:10px;-moz-border-radius:10px;border-radius:10px;margin:0 5%;vertical-align:middle;line-height:35px;">'+
									'Clean'+
								'</div>'+
							'</td>'+
						'</tr>'+
					'</table>'+
					'<div>'+
						'<table width="100%">'+
							'<tr>'+
								'<td>'+
									'<div id="gl" style="vertical-align:center">'+
										'<img src="images/gold.png" style="height:30px;">0'+
									'</div>'+
								'</td>'+
								'<td align="right">'+
									'<div>'+
										'<a href="#" onclick="share()"><img src="images/sharebutton.png" style="height:25px;"></a>'+
									'</div>'+
								'</td>'+
							'</tr>'+
						'</table>'+
					'</div>'
				)
				$('#btl').css({'margin-top':'460','margin-left':'20'})
				$('#btl').html(
				'<table>'+
					'<tr>'+
						'<td>'+
							'<a href="#" onclick="feed()"><img src="images/Buttonfeed.png" style="height:50px"></a>'+
						'</td>'+
						'<td>'+
							'<a href="#" onclick="sleep()"><img src="images/Buttonsleep.png" style="height:50px"></a>'+
						'</td>'+
						'<td>'+
							'<a href="#" onclick="clean()"><img src="images/Buttonclean.png" style="height:50px"></a>'+
						'</td>'+
					'</tr>'+
				'</table>'
				)
				$('#ctl').html('<canvas id="canvas" width="320" height="524"></canvas>')

				init_main()
				console.log("draw_main finish")
			}

			function init_main(){
				console.log("init_main start")
				$.get($add+'friendlab/'+$id+'/status').complete(function(e){
					var q = JSON.parse(e.responseText)
					$id = q.id
					$avaid = q.pic
					loadpic['user'] = image("https://graph.facebook.com/"+$avaid+"/picture?width=76&height=76")
					$pic = parseInt(q.avatar)
					var time = new Date().getTime()
					var diff = Math.floor((time-parseInt(q.edit))/900000)
					if(q.sleep==0){
						q.energy = parseInt(q.energy,10)-diff
						if(q.energy<0)q.energy=0
						q.hungry = parseInt(q.hungry,10)-diff
						if(q.hungry<0)q.hungry=0
						q.clean = parseInt(q.clean,10)-diff
						if(q.clean<0)q.clean=0

						int_decrease = setInterval(decrease,900000)
						clearInterval(int_sleep)

					}else if(q.sleep==1){
						q.energy = parseInt(q.energy,10)+Math.floor((time-parseInt(q.edit,10))/12000)
						if (q.energy>100)q.energy=100

						clearInterval(int_decrease)
						int_sleep = setInterval(sleepmode,6000)
					}
					q.edit = time
					post(q)
					update(q)
					rt()
					if(q.energy==0 || q.clean==0 || q.hungry==0){
						dead()
					}
				})
				console.log("init_main finish")
			}

			function dead(){
				console.log('dead start')
				$('#content').append('<div id="deadwindow" style="position:absolute;z-index:100;height:524;width:320;background-image:url(\'bg/dead.png\');background-size:contain"><a href="#" onclick="kill_a()"><img src=images/deadcaption.png style="margin:100 10"></a></div>')
				console.log('dead finish')
			}

			function kill_c(){
				console.log('kill c start')
				$('#deadwindow').html('')
				$('#deadwindow').css({'background-image':''})
				console.log('kill c finish')
			}

			function kill_b(){
				console.log('kill b start')
				$('#content').append('<div id="deadwindow" style="text-align:center;position:absolute;z-index:100;height:524;width:320;background-image:url(\'bg/dead.png\');background-size:contain">'+
						'<img src=images/dead.png style="margin:30 60">'+
						'<h3>Do you want to kill your friend?</h3>'+
						'<a href="#" onclick="kill_a()"><img src=images/yes.png style="width:100"></a>'+
						'<a href="#" onclick="kill_c()"><img src=images/no.png style="width:100"></a>'+
					'</div>')
				console.log('kill b finish')
			}

			function kill_a(){
				console.log('kill a start')
				$('#deadwindow').fadeOut(5000,function(){
					$('#deadwindow').html('')
					$('#deadwindow').css({'background-image':''})
					kill()
				})
				console.log('kill a finish')
			}

			function rt(){
				console.log("return lab start")

				$('#ctl').html('<canvas id="canvas" width="320" height="524"></canvas>')
				var cvs = document.getElementById("canvas")
				var cv = cvs.getContext("2d")
				cv.drawImage(loadpic['lab'],0,0,320,524)
				cv.drawImage(loadpic['user'],122,$top[$pic]+90)
				cv.drawImage(loadpic['ava'+$pic],10,$top[$pic],300,300)

				clearInterval(int_return)
				console.log("return lab finish")
			}

			function sleepmode(){
				console.log("sleepmode start")
				$.get($add+'friendlab/'+$id+'/status').complete(function(e){
					var q = JSON.parse(e.responseText)
					if(q.sleep==1){
						$('#ctl').html('<canvas id="canvas" width="320" height="524"></canvas>')
						var cvs = document.getElementById("canvas")
						var cv = cvs.getContext("2d")

						cv.drawImage(loadpic['bed1'],-80,-131,480,786)
						cv.drawImage(loadpic['user'],122,$top[$pic]-30)
						cv.drawImage(loadpic['ava'+$pic],10,$top[$pic]-120,300,300)
						cv.drawImage(loadpic['bed2'],-80,-81,480,786)

						if(q.energy<100)q.energy = parseInt(q.energy,10)+1
						q.edit = new Date().getTime()
						update(q)
						post(q)
					}
				})
				console.log("sleepmode finish")
			}

			function decrease() {
				console.log("decrease start")
				$.get($add+'friendlab/'+$id+'/status').complete(function(e){
					var q = JSON.parse(e.responseText)
					if(q.sleep==0){
						if(q.energy>0)q.energy = parseInt(q.energy,10)-1
						if(q.hungry>0)q.hungry = parseInt(q.hungry,10)-1
						if(q.clean>0)q.clean = parseInt(q.clean,10)-1
						q.edit = new Date().getTime()
						update(q)
						post(q)
					}
				})
				console.log("decrease finish")
			}

			function kill(){
				console.log('kill start')
				$.post($add+'friendlab/del/'+$id)
				testAPI()
				console.log('kill finish')
			}

			function clear(){
				console.log("clear start")
				clearInterval(int_decrease)
				clearInterval(int_sleep)
				clearInterval(int_return)
				$('#content').css({'background-image':'','background-size':'cover','background-position':'bottom'})
				$('#stl').css({'margin-top':'0','margin-left':'0'})
				$('#stl').html('')
				$('#btl').css({'margin-top':'0','margin-left':'0'})
				$('#btl').html('')
				$('#fnl').css({'margin-top':'0','margin-left':'0'})
				$('#fnl').html('')
				$('#ctl').css({'margin-top':'0','margin-left':'0'})
				$('#ctl').html('')
				console.log("clear finish")
			}

			function update(q){
				var sl = (q.sleep==0)?'false':'true'
				var hgc = (q.hungry>50)?'#66cc33':(q.hungry>20)?'#ffcc00':'#ff3300'
				var enc = (q.energy>50)?'#66cc33':(q.energy>20)?'#ffcc00':'#ff3300'
				var clc = (q.clean>50)?'#66cc33':(q.clean>20)?'#ffcc00':'#ff3300'
				$('#hg').css({'background-color':hgc,'width':parseInt(q.hungry,10)*(0.9)+'%',})
				$('#en').css({'background-color':enc,'width':parseInt(q.energy,10)*(0.9)+'%',})
				$('#cl').css({'background-color':clc,'width':parseInt(q.clean,10)*(0.9)+'%',})
				$('#gl').html('<img src="images/gold.png" style="height:30px;">'+q.gold)
				var pic = (q.sleep==1)?'sleep':(q.hungry>50&&q.energy>50&&q.clean>50)?'smile':(q.hungry<21||q.energy<21||q.clean<21)?'angry':'normal'
				$('#mood').html('<img src="images/'+pic+'.png" style="height:38;">')
			}

			function post(q){
				var time = new Date().getTime();
				$.post($add+'friendlab/'+$id+'/post/'+q.energy+'/'+q.hungry+'/'+q.clean+'/'+time+'/'+q.sleep+'/'+q.gold)
				update(q)
			}

			function share(){
				console.log("share start")
				$.post($add+'friendlab/'+$id+'/capture')
/*				html2canvas(document.body, {
					onrendered:function(canvas) {
						window.open(canvas.toDataURL())
						FB.api('/me/photos','post',{url:''}, function(response) {
							if (!response || response.error) {
								//error
							} else {
								picid = response.id
							}
						});
					}
				})
*/
				console.log("share finish")
			}

			function feed(){
				console.log("feed start")
				$.get($add+'friendlab/'+$id+'/status').complete(function(e){
					var q = JSON.parse(e.responseText)
					if(q.gold>=20 && q.clean>5){
						int_decrease = setInterval(decrease,900000)
						clearInterval(int_sleep)
						clearInterval(int_return)
						int_return = setInterval(rt,10000)

						$('#ctl').html('<canvas id="canvas" width="320" height="524"></canvas>')
						var cvs = document.getElementById("canvas")
						var cv = cvs.getContext("2d")

						cv.drawImage(loadpic['kit1'],0,0,320,524)
						cv.drawImage(loadpic['user'],122,$top[$pic]+30)
						cv.drawImage(loadpic['ava'+$pic],10,$top[$pic]-60,300,300)
						cv.drawImage(loadpic['kit2'],0,0,320,524)

						q.gold = parseInt(q.gold,10)-20
						q.hungry = parseInt(q.hungry,10)+20+Math.floor(Math.random()*6)
						if(q.hungry>100)q.hungry=100
						q.clean = parseInt(q.clean,10)-5
						q.sleep = 0
						post(q)
					}
				})
				console.log("feed finish")
			}

			function sleep(){
				console.log("sleep start")
				$.get($add+'friendlab/'+$id+'/status').complete(function(e){
					var q = JSON.parse(e.responseText)
					if(q.energy<=50&&q.sleep==0){
						clearInterval(int_return)

						$('#ctl').html('<canvas id="canvas" width="320" height="524"></canvas>')
						var cvs = document.getElementById("canvas")
						var cv = cvs.getContext("2d")

						cv.drawImage(loadpic['bed1'],0,0,320,524)
						cv.drawImage(loadpic['user'],122,$top[$pic]+90)
						cv.drawImage(loadpic['ava'+$pic],10,$top[$pic],300,300)
						cv.drawImage(loadpic['bed2'],0,-60,320,524)

						q.sleep = 1
						post(q)

						clearInterval(int_decrease)
						int_sleep = setInterval(sleepmode,6000)
					}
				})
				console.log("sleep finish")
			}

			function clean(){
				console.log("clean start")
				$.get($add+'friendlab/'+$id+'/status').complete(function(e){
					var q = JSON.parse(e.responseText)
					if(q.hungry>5){
						int_decrease = setInterval(decrease,900000)
						clearInterval(int_sleep)
						clearInterval(int_return)
						int_return = setInterval(rt,10000)

						$('#ctl').html('<canvas id="canvas" width="320" height="524"></canvas>')
						var cvs = document.getElementById("canvas")
						var cv = cvs.getContext("2d")

						cv.drawImage(loadpic['bth1'],0,0,320,524)
						cv.drawImage(loadpic['user'],122,$top[$pic]+30)
						cv.drawImage(loadpic['ava'+$pic],10,$top[$pic]-60,300,300)
						cv.drawImage(loadpic['bth2'],0,0,320,524)

						q.clean = parseInt(q.clean,10)+20+Math.floor(Math.random()*31)
						if(q.clean>100)q.clean=100
						q.hungry = parseInt(q.hungry,10)-5
						q.sleep = 0
						post(q)
					}
				})
				console.log("clean finish")
			}

			function minigame(){
				console.log("minigame start")
				$.get($add+'friendlab/'+$id+'/status').complete(function(e){
					var q = JSON.parse(e.responseText)
					if(q.energy>5 && q.clean>5 &&q.hungry>5){
						int_decrease = setInterval(decrease,900000)
						clearInterval(int_sleep)

						q.energy = parseInt(q.energy,10)-5
						q.clean = parseInt(q.clean,10)-5
						q.hungry = parseInt(q.hungry,10)-5
						q.sleep = 0
						post(q)

						htp_mini()
					}
				})
				console.log("minigame finish")
			}

			function htp_mini(){
				console.log('how to play mini game start')
				clear()
				$('#mhead').html('MonsterFriend')
				$('#lhead').html('')
				$('#rhead').html('')
				$('#stl').html(
					'<div class="minibg1" style="background-image:url(bg/minigameBG.jpg);background-size:contain;z-index:1;position:absolute;height:524;width:320;overflow:hidden"></div>'+
					'<div class="minibg2" style="background-image:url(bg/minigameBG02.png);background-size:contain;z-index:2;position:absolute;height:524;width:320;overflow:hidden"></div>'+
					'<div style="z-index:3;position:absolute;height:524;width:320;overflow:hidden"><center><a href="#" onclick="playmini()">'+
						'<img src="images/buttonplay.png" style="width:160px; margin:430 80">'+
					'</a></center></div>'+
					'<div class="mfp1" style="z-index:4;position:absolute;height:400;width:320;overflow:hidden;background-size:300px;margin:30 10;background-repeat:no-repeat"></div>'
				)
				$(document).ready(function(){
					$minipic=1;
					$(function(){
						$('div.mfp1').on('swipeleft',swipeHandler);
						function swipeHandler(event){
							if($minipic<2){
								$(event.target).removeClass('mfp1 mfp2 ');
								$(event.target).addClass( 'mfp'+($minipic+1) );
								$minipic=$minipic+1;
								$('body').trigger('create')
							}	
						}
					});
					$(function(){
						$('div.mfp1').on('swiperight',swipeHandler);
						function swipeHandler(event){
							if($minipic>1){
								$(event.target).removeClass('mfp1 mfp2 ');
								$(event.target).addClass( 'mfp'+($minipic-1) );
								$minipic=$minipic-1;
								$('body').trigger('create')
							}
						}
					});	
				});
				$('body').trigger('create')
				console.log('how to play mini game finish')
			}

			function playmini(){
				console.log('play mini game start')
				clear()
				$('#fnl').html(
					'<div style="width:320;height:524;background-image:url(bg/minigameBG.jpg);padding-left:100%;background-size:contain;z-index:1;position:absolute;background-repeat:no-repeat;overflow:hidden"></div>'+
					'<div style="width:320;height:524;background-image:url(bg/minigameBG02.png);padding-left:100%;background-size:contain;z-index:3;position:absolute;background-repeat:no-repeat;overflow:hidden;pointer-events:none;"></div>'+
					'<div aling="left" class="tmon" style="z-index:2;position:absolute;width:320;height:524;overflow:hidden">'+
						'<table border="0" style="width: 300px;height: 380;margin: 15 0 0 15;table-layout: fixed;" >'+
							'<tr>'+
								'<td><div id="t1" class="non"></div></td>'+
								'<td><div id="t2" class="non"></div></td>'+
								'<td><div id="t3" class="non"></div></td>'+
							'</tr>'+
							'<tr>'+
								'<td><div id="t4" class="non"></div></td>'+
								'<td><div id="t5" class="non"></div></td>'+
								'<td><div id="t6" class="non"></div></td>'+
							'</tr>'+
							'<tr>'+
								'<td><div id="t7" class="non"></div></td>'+
								'<td><div id="t8" class="non"></div></td>'+
								'<td><div id="t9" class="non"></div></td>'+
							'</tr>'+
							'<tr>'+
								'<td><div id="t10" class="non"></div></td>'+
								'<td><div id="t11" class="non"></div></td>'+
								'<td><div id="t12" class="non"></div></td>'+
							'</tr>'+
						'</table>'+
						'<br>'+
						'<table border="0" style="width:100%;background-color: rgba(0, 0, 0, 0.4);table-layout: fixed;">'+
							'<col width="15%">'+
							'<col width="40%">'+
							'<col width="45%">'+
							'<tr>'+
								'<td>'+
									'<div></div>'+
									'<div> '+
										'<div  style="text-align:center;font-size:15px;">Time</div>'+
										'<div style="text-align:center;font-size:35px;" id="time">60</div>'+
									'</div>'+
								'</td>'+
								'<td>'+
									'<div  style="text-align:center;font-size:15px;">Combo</div>'+
									'<div style="text-align:center;font-size:35px;" id="combo">0</div>'+
								'</td>'+
								'<td>'+
									'<div  style="text-align:center;font-size:15px;">Totol Score</div>'+
									'<div style="text-align:center;font-size:35px;" id="point">0</div>'+
								'</td>'+
							'</tr>'+
						'</table>'+
					'</div>'
				)
				$('body').trigger('create')
				$(document).ready(function(){
					var status =[1,1,1,1,1,1,1,1,1,1,1,1];
					clock = 60;
					$point=0;
					$combo1=0; 
					$combo2=0; 
					$combo3=0; 
					$combo4=0; 
					timecount()
					show()
					show2()
					show3()
					show4()
					showdoc()
					plustime()
					
					$('.tmon').on('click', '.mon1', function() { 
						$(this).addClass('boom1'); 
						$(this).removeClass('mon1');
						$('#point').html($point+=100);
						if($combo2==0 && $combo3==0 && $combo4== 0){
							$combo1++
							console.log($combo1)
							$('#combo').html("A"+ $combo1);}
					})

					$('.tmon').on('click', '.mon2', function() { 
						$(this).addClass('boom2'); 
						$(this).removeClass('mon2');
						$('#point').html($point+=150)
						if($combo1==0 && $combo3==0 && $combo4== 0){
							$combo2++
							console.log($combo2)
							$('#combo').html("B"+$combo2);}
					})

					$('.tmon').on('click', '.mon3', function() { 
						$(this).addClass('boom3'); 
						$(this).removeClass('mon3');
						$('#point').html($point+=200)
						if($combo2==0 && $combo1==0 && $combo4== 0){
							$combo3++
							console.log($combo3)
							$('#combo').html("C"+$combo3);}
					})

					$('.tmon').on('click', '.mon4', function() { 
						$(this).addClass('boom4'); 
						$(this).removeClass('mon4');
						$('#point').html($point+=1000)
						if($combo2==0 && $combo3==0 && $combo1== 0){
							$combo4++
							console.log($combo4)
							$('#combo').html("D"+$combo4);}
					})

					$('.tmon').on('click', '.timer', function() { 
						$(this).addClass('plus3'); 
						$(this).removeClass('timer');
						$("#time").html(clock+=3)
					})

					$('.tmon').on('click', '.doc', function() { 
						$(this).addClass('docomg'); 
						$(this).removeClass('doc');
						//$('#point').html($point-=1000)
						if($combo1>0)$point=pcombo($combo1,100,$point),$combo1=0
						if($combo2>0)$point=pcombo($combo2,150,$point),$combo2=0
						if($combo3>0)$point=pcombo($combo3,200,$point),$combo3=0
						if($combo4>0)$point=pcombo($combo4,500,$point),$combo4=0
						$('#combo').html('Get')
					})
				});
				console.log('play mini game finish')
			}

			function show_score(sc){
				var g = Math.ceil(parseInt(sc,10)/((Math.random()*4000)+1000))
				$('#btl').html(
					'<div style="width:320;height:524;background-image:url(\'bg/sel.png\');position:absolute;text-align:center;overflow:hidden">'+
						'<br><br>'+
						'<div>'+
							'<h1>Your score is</h1>'+
							'<div style="background-image:url(\'bg/white.png\')"><h2>'+sc+' point.</h2></div>'+
						'</div>'+
						'<br><br>'+
						'<div>'+
							'<h1>You got</h1>'+
							'<div style="background-image:url(\'bg/white.png\')"><h2>'+g+' G</h2></div>'+
						'</div>'+
						'<br><br>'+
						'<div>'+
							'<a href="#" onclick="calculate('+g+')"><img src=images/Buttonback.png style="width:150px"></a>'+
						'</div>'+
					'</div>'
				)
			}

			function calculate(g){
				console.log("calculate start")
				$.get($add+'friendlab/'+$id+'/status').complete(function(e){
					var q = JSON.parse(e.responseText)
					if(q.energy>5 && q.clean>5 &&q.hungry>5){
						int_decrease = setInterval(decrease,900000)
						clearInterval(int_sleep)
						q.gold = parseInt(q.gold,10)+parseInt(g,10)
						post(q)

						draw_main()
					}
				})
				console.log("calculate finish")
			}

			function pcombo(combo,p,point){
				if(combo<5) point=point+combo*p*1.25
				if(combo<10)point=point+combo*p*1.5
				if(combo<15)point=point+combo*p*1.75
				if(combo<20)point=point+combo*p*2
				if(combo<25)point=point+combo*p*2.25
				if(combo<30)point=point+combo*p*2.5
				if(combo<35)point=point+combo*p*2.75
				if(combo>35)point=point+combo*p*3
				$('#point').html(point)
				return point
			}

			function timecount(){
				clock-- 
				if(clock>=0){
					setTimeout(timecount,1000)
				$('#time').html(clock)
				}else{
					if($combo1>0)$point=pcombo($combo1,100,$point)
					if($combo2>0)$point=pcombo($combo2,150,$point)
					if($combo3>0)$point=pcombo($combo3,200,$point)
					if($combo4>0)$point=pcombo($combo4,500,$point)
					$('#combo').html('Get')
					setTimeout(function(){show_score($point)},3000)
				}
			}
			
			function show(){	
				var appear = 1+Math.floor(Math.random()*12)
				var time=1+Math.floor(Math.random()*5)
				if(status[appear-1]!=0){
					status[appear-1]=0
					$('#t'+appear).html("<div class='mon1'></div>")
					setTimeout(function(){
						$('#t'+appear).html("<div class='non'></div>")
						status[appear-1]=1
					},3000)//disappear
					if(clock>=5)setTimeout(show,time*300)//appear
				}else{
					show()
				}
			}
			
			function show2(){	
				var appear = 1+Math.floor(Math.random()*12)
				var time=1+Math.floor(Math.random()*5)
				if(status[appear-1]!=0){
					status[appear-1]=0
					$('#t'+appear).html("<div class='mon2'></div>")
					setTimeout(function(){
						$('#t'+appear).html("<div class='non'></div>")
						status[appear-1]=1
						},3000)//disappear
					if(clock>=3)setTimeout(show2,time*500)//appear
				}else{
					show2()
				}
			}

			function show3(){	
				var appear = 1+Math.floor(Math.random()*12)
				var time=1+Math.floor(Math.random()*5)
				if(status[appear-1]!=0){
					status[appear-1]=0
					$('#t'+appear).html("<div class='mon3'></div>")
					setTimeout(function(){
						$('#t'+appear).html("<div class='non'></div>")
						status[appear-1]=1
					},2500)//disappear
					if(clock>=3)setTimeout(show3,time*800)//appear
				}else{
					show3()
				}
			}

			function show4(){	
				var appear = 1+Math.floor(Math.random()*12)
				var time=1+Math.floor(Math.random()*5)
				if(status[appear-1]!=0){
					status[appear-1]=0
					$('#t'+appear).html("<div class='mon4'></div>")
					setTimeout(function(){
						$('#t'+appear).html("<div class='non'></div>")
						status[appear-1]=1
					},2000)//disappear
					if(clock>=3)setTimeout(show4,time*2000)//appear
				}else{
					show4()
				}
			}

			function showdoc(){	
				var appear = 1+Math.floor(Math.random()*12)
				var time=1+Math.floor(Math.random()*3)
				if(status[appear-1]!=0){
					status[appear-1]=0
					$('#t'+appear).html("<div class='doc'></div>")
					setTimeout(function(){
						$('#t'+appear).html("<div class='non'></div>")
						status[appear-1]=1
					},2500)//disappear
					if(clock>=5)setTimeout(showdoc,time*1000)//appear
				}else{
					showdoc()
				}
			}

			function plustime(){	
				var appear = 1+Math.floor(Math.random()*12)
				var time=1+Math.floor(Math.random()*4)
				if(status[appear-1]!=0){
					status[appear-1]=0
					$('#t'+appear).html("<div class='timer'></div>")
					setTimeout(function(){
						$('#t'+appear).html("<div class='non'></div>")
						status[appear-1]=1
					},2000)//disappear
					if(clock>=5)setTimeout(plustime,time*2000)//appear
				}else{
					plustime()
				}
			}

			function image(des){
				var new_image = new Image()
				new_image.src = des
				return new_image
			}

		</script>
	</div>


	<!-- Header ..............................................................................................-->


	<div data-theme="a" class="my-page" style='position:relative;z-index:5' >
		<div data-role="header">
			<div class="ui-btn-right" id="rhead"></div>
			<span class="ui-title" id="mhead">Friend Lab</span>
			<div class="ui-btn-left" id="lhead"></div>
		</div>
	</div>


	<!-- Content .............................................................................................-->


	<div id="content" style='position:relative;z-index:0;width:320px;height:524px;background-image:url(bg/lab1x.jpg);background-size:cover;background-position:bottom;'>
	<!-- ..... status bar layer ......................................................................... -->
		<div id="stl" style='position:absolute;z-index:5'>
			<img src="GRAPHIC/logoapp.png" style="width:360;height:240;margin:40 -20">
			<a href"#" onclick="FB.login(function(){},{scope:'read_friendlists'})"><img src="GRAPHIC/facebook.png" style="width:210;height:70;margin:0 55"></a>
		</div>
		<!-- ..... button layer ............................................................................. -->
		<div id="btl" style='position:absolute;z-index:4'></div>
		<!-- ..... front background layer ................................................................... -->
		<div id="fnl" style='position:absolute;z-index:3'></div>
		<!-- ..... charactor layer .......................................................................... -->
		<div id="ctl" style='position:absolute;z-index:2'></div>
	</div>
	</body>
</html>